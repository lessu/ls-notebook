# Build Linux Full

This manual use a example of orange pi z2w;

# 1.Hardware

https://beepy.sqfmi.com/docs/hardware/pinouts

Uart

GPIO14:TXD

LEFT side PIN

```
|[]| GPIO16
|()| GPIO03
|()| GPIO02
|()| GPIO14 TXD
|()| GPIO15 RXD
|()| GPIO18
|()| 5V
|()| 3V3
|()| GND
|()| GND
```



# 2.U-boot

clone the official git.

For orangepi-zero2w,h618 use the next branch

https://github.com/orangepi-xunlong/u-boot-orangepi.git

## bl31.bin

U-Boot need a bl31.bin to boot during spl.we should download the bin or build it by hand.



## build UBoot

```bash
# use gcc-arm-11.2-2022.02-x86_64-aarch64-none-linux-gnu
# export PATH=$PATH:/home/lessu/DIY/orangepi-build/toolchains/gcc-arm-11.2-2022.02-x86_64-aarch64-none-linux-gnu/bin
make ARCH=arm CROSS_COMPILE="aarch64-none-linux-gnu-" orangepi_zero2w_defconfig

make -j9 ARCH=arm CROSS_COMPILE="aarch64-none-linux-gnu-"

```

### why orangepi_zero2w_defconfig?

```
the available target is under configs.
```



## The dest

for each different board is different,for H618 it is 

`./u-boot-sunxi-with-spl.bin`

## Deploy

```
# if [[ -f $1/u-boot-sunxi-with-spl.bin ]]; then
sudo dd if=/dev/zero of=/dev/sdb bs=1k count=1023 seek=1 status=noxfer
sudo dd if=u-boot-sunxi-with-spl.bin of=/dev/sdb bs=1k seek=8 conv=fsync

# caller from:
# /usr/lib/orangepi-config/functions.sh

# compare
xxd u-boot-sunxi-with-spl.bin > u-boot-sunxi-with-spl.hex
sudo dd if=/dev/sdb bs=1k skip=8 count=600 of=raw && xxd raw  > raw.hex
diff raw.hex u-boot-sunxi-with-spl.hex | less
```

### Notice

- dtb is already in this file. No more operation should be done for dtb flash.(in H618 case)

### Boot script

The uboot reads `/boot/boot.scr` to excute bootcmd.For some config,this file should be edited(generated).



the env is like,predefined in u-boot source code

``` 
#define MEM_LAYOUT_ENV_SETTINGS \
	"bootm_size=" BOOTM_SIZE "\0" \
	"kernel_addr_r=" KERNEL_ADDR_R "\0" \
	"fdt_addr_r=" FDT_ADDR_R "\0" \
	"scriptaddr=" SCRIPT_ADDR_R "\0" \
	"pxefile_addr_r=" PXEFILE_ADDR_R "\0" \
	"fdtoverlay_addr_r=" FDTOVERLAY_ADDR_R "\0" \
	"ramdisk_addr_r=" RAMDISK_ADDR_R "\0"
```

- /boot/boot.scr:

```\# DO NOT EDIT THIS FILE
#
# Please edit /boot/orangepiEnv.txt to set supported parameters
#

# default values
setenv load_addr "0x45000000"
setenv overlay_error "false"
setenv rootdev "/dev/mmcblk0p1"
setenv verbosity "1"
setenv rootfstype "ext4"
setenv console "both"
setenv docker_optimizations "on"
setenv bootlogo "false"

# Print boot source
itest.b *0x10028 == 0x00 && echo "U-boot loaded from SD"
itest.b *0x10028 == 0x02 && echo "U-boot loaded from eMMC or secondary SD"
itest.b *0x10028 == 0x03 && echo "U-boot loaded from SPI"

echo "Boot script loaded from ${devtype}"

if test -e ${devtype} ${devnum} ${prefix}orangepiEnv.txt; then
        load ${devtype} ${devnum} ${load_addr} ${prefix}orangepiEnv.txt
        env import -t ${load_addr} ${filesize}
fi

if test "${console}" = "display" || test "${console}" = "both"; then setenv consoleargs "console=ttyS0,115200 console=tty1"; fi
if test "${console}" = "serial"; then setenv consoleargs "console=ttyS0,115200"; fi
if test "${bootlogo}" = "true"; then
        setenv consoleargs "splash plymouth.ignore-serial-consoles ${consoleargs}"
else
        setenv consoleargs "splash=verbose ${consoleargs}"
fi

# get PARTUUID of first partition on SD/eMMC it was loaded from
# mmc 0 is always mapped to device u-boot (2016.09+) was loaded from
if test "${devtype}" = "mmc"; then part uuid mmc 0:1 partuuid; fi

setenv bootargs "root=${rootdev} rootwait rootfstype=${rootfstype} ${consoleargs} consoleblank=0 loglevel=${verbosity} ubootpart=${partuuid} usb-storage.quirks=${usbstoragequirks} ${extraargs} ${extraboardargs}"

...

load ${devtype} ${devnum} ${fdt_addr_r} ${prefix}dtb/${fdtfile}
fdt addr ${fdt_addr_r}
fdt resize 65536

...

load ${devtype} ${devnum} ${ramdisk_addr_r} ${prefix}uInitrd
load ${devtype} ${devnum} ${kernel_addr_r} ${prefix}Image

booti ${kernel_addr_r} ${ramdisk_addr_r} ${fdt_addr_r}

# Recompile with:
# mkimage -C none -A arm -T script -d /boot/boot.cmd /boot/boot.scr\
```
- The /boot dir
```
drwxr-xr-x  4 root root     4096 Dec  3 11:21 .
drwxr-xr-x 19 root root     4096 Sep 13 04:11 ..
-rw-r--r--  1 root root        0 Sep 13 04:11 .next
lrwxrwxrwx  1 root root       23 Sep 13 04:11 Image -> vmlinuz-6.1.31-sun50iw9
-rw-r--r--  1 root root  3472604 Sep 13 04:08 System.map-6.1.31-sun50iw9
-rw-rw-r--  1 root root   230456 Sep 13 04:11 boot.bmp
-rw-rw-r--  1 root root     3564 Sep 13 04:10 boot.cmd
-rw-rw-r--  1 root root     3636 Sep 13 04:12 boot.scr
-rw-r--r--  1 root root   206693 Sep 13 04:08 config-6.1.31-sun50iw9
lrwxrwxrwx  1 root root       19 Sep 13 04:11 dtb -> dtb-6.1.31-sun50iw9
drwxr-xr-x  3 root root     4096 Sep 13 04:11 dtb-6.1.31-sun50iw9
-rw-r--r--  1 root root 10787725 Nov 12 16:46 initrd.img-6.1.31-sun50iw9
-rwxrwxr-x  1 root root  1152056 Sep 13 04:11 logo.bmp
-rw-rw-r--  1 root root      239 Dec  3 11:21 orangepiEnv.txt
-rw-rw-r--  1 root root     1542 Sep 13 04:11 orangepi_first_run.txt.template
drwxr-xr-x  2 root root     4096 Nov 11 13:42 overlay-user
lrwxrwxrwx  1 root root       23 Nov 12 16:46 uInitrd -> uInitrd-6.1.31-sun50iw9
-rw-r--r--  1 root root 10787789 Nov 12 16:46 uInitrd-6.1.31-sun50iw9
-rw-r--r--  1 root root  9367961 Sep 13 04:08 vmlinuz-6.1.31-sun50iw9
```



```
vmlinuz-6.1.31-sun50iw9: gzip compressed data, max compression, from Unix, original size modulo 2^32 22534152
uInitrd-6.1.31-sun50iw9: u-boot legacy uImage, uInitrd, Linux/ARM 64-bit, RAMDisk Image (gzip), 10787725 bytes, Sun Nov 12 16:46:05 2023, Load Address: 00000000, Entry Point: 00000000, Header CRC: 0X43C169FA, Data CRC: 0X22DFBEEE

```

- booti wiki

    https://docs.u-boot.org/en/v2021.04/usage/booti.html

# 3.Linux

## Build

```bash
# use gcc-arm-11.2-2022.02-x86_64-aarch64-none-linux-gnu
# export PATH=$PATH:/home/lessu/DIY/orangepi-build/toolchains/gcc-arm-11.2-2022.02-x86_64-aarch64-none-linux-gnu/bin
make ARCH=arm64 CROSS_COMPILE="aarch64-none-linux-gnu-" linux_sunxi64_defconfig

make -j24 ARCH=arm64 CROSS_COMPILE="aarch64-none-linux-gnu-" LOCALVERSION=-sun50iw9 Image modules dtbs
```

The Image target can be found in 

`arch/arm64/boot/Makefile`

```
targets := Image Image.bz2 Image.gz Image.lz4 Image.lzma Image.lzo Image.zst
```

zImage is no longer supported.the kernel should be decompressed by u-boot



### why linux_sunxi64_defconfig?

Usually the avaliable target is under arch/$(ARCH)/configs

In orangepi case,the configure file is downloaded from its build tool.we just copy it to .config

### The Dest

The target are:

<svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
 <g>
  <title>Layer 1</title>
  <path stroke="#000" id="svg_1" d="m71.36111,47.44442l91,0l0,281.00001l-91,0l0,-281.00001z" opacity="undefined" fill="#fff"/>
  <text xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" stroke-width="0" id="svg_9" y="371.05523" x="436.02741" stroke="#000" fill="#000000">zImage</text>
  <g id="svg_13">
   <path stroke="#000" id="svg_4" d="m422.02771,117.05556l91,0l0,209.99998l-91,0l0,-209.99998z" opacity="undefined" fill="#fff"/>
   <path id="svg_5" d="m422.02771,167.05553l91,0l0,160.00002l-91,0l0,-160.00002z" opacity="undefined" stroke="#000" fill="#fff"/>
   <text stroke-width="0" font-style="normal" stroke="#000" transform="matrix(0.777854 0 0 0.856121 326.813 68.8071)" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" id="svg_6" y="224.20048" x="152.49877" fill="#000000">Image</text>
   <text transform="matrix(0.589581 0 0 0.589581 119.131 35.0524)" stroke="#000" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" stroke-width="0" id="svg_7" y="166.00317" x="538.66472" fill="#000000">Decompress</text>
   <text stroke="#000" transform="matrix(0.619426 0 0 0.619426 114.166 40.1684)" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" stroke-width="0" id="svg_8" y="177.62402" x="552.11472" fill="#000000">code</text>
  </g>
  <g id="svg_19">
   <path stroke="#000" id="svg_14" d="m551.88879,117.75l91,0l0,210l-91,0l0,-210z" opacity="undefined" fill="#fff"/>
   <path id="svg_15" d="m551.88879,167.74997l91,0l0,160.00003l-91,0l0,-160.00003z" opacity="undefined" stroke="#000" fill="#fff"/>
   <text stroke-width="0" font-style="normal" stroke="#000" transform="matrix(0.777854 0 0 0.856121 446.674 69.5015)" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" id="svg_16" y="224.20048" x="152.49877" fill="#000000">Image</text>
   <text transform="matrix(0.589581 0 0 0.589581 119.131 35.0524)" stroke="#000" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" stroke-width="0" id="svg_17" y="167.18103" x="758.92462" fill="#000000">Decompress</text>
   <text stroke="#000" transform="matrix(0.619426 0 0 0.619426 114.166 40.1684)" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" stroke-width="0" id="svg_18" y="178.74513" x="761.7621" fill="#000000">code</text>
  </g>
  <rect stroke="#000" id="svg_20" height="36.1111" width="90.27773" y="81.47205" x="551.99958" fill="#ffffff"/>
  <text transform="matrix(0.641095 0 0 0.641095 152.529 24.428)" stroke="#000" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" stroke-width="0" id="svg_21" y="108.34152" x="664.26033" fill="#000000">u-boot</text>
  <text transform="matrix(0.641095 0 0 0.641095 152.529 24.428)" stroke="#000" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" stroke-width="0" id="svg_22" y="128.92262" x="666.42676" fill="#000000">header</text>
  <text xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" stroke-width="0" id="svg_23" y="372.44411" x="564.49957" stroke="#000" fill="#000000">uImage</text>
  <text xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" stroke-width="0" id="svg_24" y="372.66634" x="83.02749" stroke="#000" fill="#000000">vmlinux</text>
  <path stroke="#000" id="svg_2" d="m271.36111,171.44443l91,0l0,153l-91,0l0,-153z" opacity="undefined" fill="#fff"/>
  <text stroke-width="0" font-style="normal" stroke="#000" transform="matrix(0.777854 0 0 0.856121 109.618 51.0293)" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" id="svg_10" y="232.37689" x="233.49083" fill="#000000">Image</text>
  <text stroke="#000" transform="matrix(1.0862 0 0 1.0862 -14.0498 -5.30101)" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" stroke-width="0" id="svg_11" y="75.33354" x="86.58648" fill="#000000">elf</text>
  <text stroke="#000" transform="matrix(0.762786 0 0 0.762786 34.6381 33.2057)" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" id="svg_12" y="234.03064" x="66.94422" stroke-width="0" fill="#000000">symbols</text>
  <text stroke-width="0" font-style="normal" stroke="#000" transform="matrix(1.01704 0 0 1.03963 117.993 117.089)" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" id="svg_25" y="235.88107" x="165.35465" fill="#000000">Image</text>
  <text xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" stroke-width="0" id="svg_26" y="447.66634" x="421.02749" stroke="#000" fill="#000000">vmlinuz</text>
  <polyline stroke-linecap="round" id="svg_29" points="296,442 296,443 " stroke-width="0" stroke="#000" fill="none"/>
  <text stroke="#000" transform="rotate(89.4546 478.268 401.457) matrix(3.75949 0 0 15.3356 -1008.18 -6371.11)" xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" id="svg_30" y="448.7783" x="390.05837" stroke-width="0" fill="#000000">}</text>
  <text xml:space="preserve" text-anchor="start" font-family="Noto Sans JP" font-size="22" id="svg_31" y="212" x="182" stroke-width="0" stroke="#000" fill="#000000">objcopy</text>
  <path id="svg_35" d="m211.54944,266.85477l7.13425,-7.06314l-13.79402,0l-13.79471,0l0,-4.37259l0,-4.37248l13.63609,0c7.50023,0 13.63609,-0.22189 13.63609,-0.49289c0,-0.27043 -2.98553,-3.44955 -6.63437,-7.0634l-6.63506,-6.57109l6.13243,0l6.13312,0l9.36584,9.25847l9.36584,9.25885l-9.3837,9.24133l-9.38438,9.24133l-6.45584,0l-6.45653,0l7.13493,-7.06439l0,0z" stroke-width="0" stroke="#000" fill="#000000"/>
 </g>
</svg>
| file    | target                                                      | path                        | desc             |
| ------- | ----------------------------------------------------------- | --------------------------- | ---------------- |
| vmlinux | Image                                                       | ./                          | elf              |
| Image   | Image                                                       | arch/arm64/boot/            | bootable         |
| Image.* | Image.bz2 Image.gz Image.lz4 Image.lzma Image.lzo Image.zst | arch/arm64/boot/            | compressed image |
| header  |                                                             | kernel/kheaders_data.tar.xz |                  |
| *.mod   | modules                                                     |                             |                  |
| *.dbo   | dtbs                                                        |                             |                  |



### Deploy

Example of:`orangepi zero2w`

copy `Image.*` to `sdcard/boot/`

and ```ln -s  Image.* Image```



## TRIM the kernel

Compress benchmark

| Var                          | Image    | Image.gz | Image.zst |
| ---------------------------- | -------- | -------- | --------- |
| Size                         | 22534152 | 9368347  | 7973472   |
| Decompress time (referenced) |          | 1.4      | 1.3       |



- Remove feature

| Var                                                          | Image    |         |
| ------------------------------------------------------------ | -------- | ------- |
| Base                                                         | 22534152 |         |
| - Kernel Features > ARM errata workarounds via the alternatives framework<br> all None Cortex-A53 options | 22534152 | 0       |
| Device Drivers GNSS receiver support<br>Device Drivers > NVME Support NVM Express over Fabrics TCP host driver<br><br>HiSilicon Hi6421v600 IRQ and powerkey<br/>Open Profile for DICE driver<br/>Guest vCPU stall detector<br><br>SCSI device support<br/>SCSI disk support<br/>SCSI generic support<br/>/dev/bsg support (SG v4)<br/>SCSI low-level drivers  ----<br><br>Serial ATA and Parallel ATA drivers (libata)  ---><br>Multiple devices driver support (RAID and LVM)  ---- | 21917704 | 616,448 |
|                                                              |          |         |
|                                                              |          |         |
|                                                              |          |         |
|                                                              |          |         |
|                                                              |          |         |















## Ref. A Table of menu config items

### General setup
| Item | Desc |      |
| ---- | ---- | ---- |
|      |      |      |
|      |      |      |
|      |      |      |

### Kernel Feature

| Item                                                  | Desc                                                         |      |
| ----------------------------------------------------- | ------------------------------------------------------------ | ---- |
| ARM errata workarounds via the alternatives framework | 这个选项从名字上可以看出，对于有些硬件和芯片在配合或本身存在一些问题，这里从内核代码出发给硬件能够正常使用打的一些补丁或workarounds。进到这个选项里，大家可以看到很多有问题的硬件workarounds，如果你不确定你自己板子有些什么硬件，可以缺省使用缺省配置，如果你能确定你用的板卡上的芯片和硬件，可根据需要进行裁剪。 |      |
|                                                       |                                                              |      |
|                                                       |                                                              |      |



# Refs

## 1. Change to Btrfs

1. u-boot menuconfig -> file system-> btrfs enable

2. flash u-boot

3. change /boot/orangepiEnv.txt

    ```
    rootdev=UUID=xxxxxxx # get from ls -l /dev/disk/by-uuid
    rootfstype=btrfs
    ```

4. change /boot/boot.cmd

5. Change /etf/fstab

    ```
    UUID=xxx / btrfs defaults,noatime,commit=600 0 1
    ```

    



## 2. Verbose linux eraly log

- change /boot/boot.cmd

```
setenv bootargs "...  verbose INIT_VERBOSE=yes earlyprintk=ttyS0 "
```

- make it 

```
    sudo mkimage -C none -A arm -T script -d /media/sdcard/boot/boot.cmd /media/sdcard/boot/boot.scr
```



Or

append lines to orangepiEnv.txt (Note tested)

```
extraargs=verbose INIT_VERBOSE=yes earlyprintk=ttyS0
```

